# CLAUDE.md - Project Guidelines & Operating Manual
**CRITICAL:** If you are about to run any git command that writes history (`commit`, `merge`, `rebase`, `reset`, `push`), you MUST first confirm the current branch is `feature/*`.

## 1. Project Overview
**Goal:** Create a "Routing Cycle Detector" CLI tool to find the longest cycle in a large, newline-delimited dataset of claims.
**Deliverable:** A single standalone Python script (`my_solution.py`) that acts as a self-contained executable.
**Input Handling:** The tool must accept a local file path (e.g., `data/large_input_v1.txt`).
**Output:** The script must print exactly one line to STDOUT: `<claim_id>,<status_code>,<cycle_length>`. (Or `NA,NA,0` if no cycles found).

## 2. Data & Logic Specifications (CRITICAL)
- **Input Format:** `Source|Destination|ClaimID|StatusCode`
- **Delimiter:** Pipe character (`|`).
- **Pass 1 I/O Safety:** Bucket writes use an LRU file-handle cache to cap open descriptors (`MAX_OPEN_HANDLES`) and avoid `ulimit -n` failures. :contentReference[oaicite:6]{index=6}

- **Data Constraints:**
  - File may contain **millions** of distinct `ClaimID`s.
  - Strategy: **2-Pass Partitioning** (Stream to disk buckets -> Parallel Process).
- **Cycle Definition:**
  - A sequence of hops where `ClaimID` and `StatusCode` are identical for every hop.
  - Must form a closed loop.
  - **Optimization:** Use O(N) detection for functional graphs (max out-degree â‰¤ 1) and DFS for general graphs.

## 3. Technical Stack
- **Python:** - **Target:** 3.14t (Free-threaded) for maximum performance.
  - **Minimum:** 3.10+ (Supported via Multiprocessing fallback).
- **Package Manager:** `uv` (for script management and execution).
- **Linting:** `ruff` (enforce PEP 8).
- **Architecture:** `my_solution.py` is the deliverable. It is generated by `build.py` from `src/` modules; edit `src/` and rebuild (do not hand-edit `my_solution.py`).

## 4. Workflow Rules
- **Branching:** Create feature branches (`feature/name`) for all changes.
- **Verification:** - Use `pytest` for logic verification.
  - Run `ruff check .` before committing.
- **Pull Requests:** Raise PRs via GitHub MCP upon feature completion.

## 5. Coding Standards & Implementation Details
### Standalone Script Requirements (PEP 723)
The final `my_solution.py` and `my_solution_benchmark_gil.py` must be executable standalone scripts.
- **Shebang:** Must start with `#!/usr/bin/env -S uv run --script`.
- **Metadata:** Must include a TOML `/// script` block declaring:
  - `requires-python = ">=3.10"`
  - `dependencies = []` (Standard library only).
- **No Sidecars:** Do not generate or rely on `.lock` files.

### Benchmarking Strategy
- `my_solution_benchmark_gil.py` compares free-threaded vs forced GIL (`PYTHON_GIL=1`) using multiple alternating trials.
- Memory must be reported as peak RSS of the full process tree (parent + children), since ProcessPool hides memory in worker processes.

### GIL & Concurrency (Hybrid Model)
- **Auto-Detection:** The solution must check `sys._is_gil_enabled()` (safely handling older versions).
- **Executor Selection:**
  - **GIL Disabled (Free-threading):** Use `ThreadPoolExecutor`. (Preferred).
  - **GIL Enabled (Legacy/Standard):** Use `ProcessPoolExecutor`. (Fallback).
- **Data Safety:** Use "Shared-Nothing" architecture (Partitioning) to avoid locks entirely.

## 7. Command Map
- **Run Solution:** `./my_solution.py data/large_input_v1.txt`
- **Run Benchmark:** `./my_solution_benchmark_gil.py data/large_input_v1.txt`
- **Run Tests:** `uv run pytest`
- **Build Single File:** `uv run build.py`